---
/**
 * FlagCard.astro
 * Tarjeta de flag CTF
 */

import DifficultyBadge from '@/components/ui/DifficultyBadge.astro';

export interface Props {
  id: string;
  title: string;
  description: string;
  category: string;
  difficulty: 'Básico' | 'Intermedio' | 'Avanzado';
  methodologies?: string[];
  correctFlag?: string;
}

const { id, title, description, category, difficulty, methodologies = [], correctFlag } = Astro.props;
---

<div class="card p-6" data-flag-id={id}>
  <div class="mb-4">
    <div class="flex items-start justify-between mb-3">
      <div class="flex-1">
        <h3 class="font-semibold text-white mb-2 text-lg">{title}</h3>
        <p class="text-sm text-slate-400 mb-3">{description}</p>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-3 mb-3">
      <DifficultyBadge difficulty={difficulty} />
      <span class="text-xs text-slate-500 bg-slate-800 px-2 py-1 rounded">{category}</span>
    </div>

    {methodologies && methodologies.length > 0 && (
      <div class="mt-3 p-3 rounded-lg bg-slate-900/50 border border-slate-700">
        <p class="text-xs text-slate-500 font-medium mb-2">Metodologías:</p>
        <div class="flex flex-wrap gap-2">
          {methodologies.map((method) => (
            <span class="text-xs text-lab-primary-400 bg-lab-primary-500/10 px-2 py-1 rounded border border-lab-primary-500/20">
              {method}
            </span>
          ))}
        </div>
      </div>
    )}
  </div>

  <!-- Estado completado -->
  <div id={`completed-${id}`} class="hidden mt-4 p-4 rounded-lg bg-green-500/10 border border-green-500/30">
    <div class="flex items-center gap-2 mb-2">
      <svg
        class="w-5 h-5 text-green-400"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <span class="text-sm text-green-400 font-medium">Flag verificada correctamente</span>
    </div>
    <div class="mt-2 p-2 rounded bg-slate-900/50 border border-green-500/20">
      <p class="text-xs text-slate-400 mb-1">Flag capturada:</p>
      <code id={`flag-value-${id}`} class="text-sm text-green-400 font-mono break-all"></code>
    </div>
  </div>

  <!-- Formulario de flag -->
  <div id={`form-${id}`} class="mt-4">
    <div class="flex gap-2">
      <input
        type="text"
        id={`flag-input-${id}`}
        placeholder="Pega tu flag aquí (FLAG{...})"
        class="flex-1 px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-lab-primary-500 focus:ring-1 focus:ring-lab-primary-500"
      />
      <button
        id={`submit-${id}`}
        class="btn-primary px-6 whitespace-nowrap"
      >
        Verificar
      </button>
    </div>
    <div id={`error-${id}`} class="hidden mt-2 text-sm text-red-400"></div>
  </div>
</div>

<script define:vars={{ flagId: id, correctFlagValue: correctFlag }}>
  (function() {
    const submitButton = document.getElementById(`submit-${flagId}`);
    const flagInput = document.getElementById(`flag-input-${flagId}`);
    const completedDiv = document.getElementById(`completed-${flagId}`);
    const formDiv = document.getElementById(`form-${flagId}`);
    const errorDiv = document.getElementById(`error-${flagId}`);
    const flagValueDiv = document.getElementById(`flag-value-${flagId}`);

    // Verificar si ya está completado (desde localStorage)
    const savedFlag = localStorage.getItem(`flag-${flagId}`);
    if (savedFlag && savedFlag === correctFlagValue) {
      if (completedDiv) completedDiv.classList.remove('hidden');
      if (formDiv) formDiv.classList.add('hidden');
      if (flagValueDiv) flagValueDiv.textContent = savedFlag;
    }

    submitButton?.addEventListener('click', () => {
      const userFlag = flagInput?.value.trim() || '';
      
      if (!userFlag) {
        if (errorDiv) {
          errorDiv.textContent = 'Por favor ingresa una flag';
          errorDiv.classList.remove('hidden');
        }
        return;
      }

      // Verificar formato básico
      if (!userFlag.startsWith('FLAG{') || !userFlag.endsWith('}')) {
        if (errorDiv) {
          errorDiv.textContent = 'Formato incorrecto. Debe ser FLAG{...}';
          errorDiv.classList.remove('hidden');
        }
        return;
      }

      // Verificar flag
      if (userFlag === correctFlagValue) {
        // Guardar en localStorage
        localStorage.setItem(`flag-${flagId}`, userFlag);
        
        // Mostrar estado completado
        if (completedDiv) completedDiv.classList.remove('hidden');
        if (formDiv) formDiv.classList.add('hidden');
        if (flagValueDiv) flagValueDiv.textContent = userFlag;
        if (errorDiv) errorDiv.classList.add('hidden');
        
        // Disparar evento personalizado para actualizar estadísticas
        window.dispatchEvent(new CustomEvent('flag-completed'));
      } else {
        if (errorDiv) {
          errorDiv.textContent = 'Flag incorrecta. Intenta de nuevo.';
          errorDiv.classList.remove('hidden');
        }
        if (flagInput) flagInput.value = '';
      }
    });

    // Permitir Enter para enviar
    flagInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitButton?.click();
      }
    });
  })();
</script>
