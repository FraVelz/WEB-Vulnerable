---
/**
 * flags.astro
 * Página de CTF (Capture The Flag) - Sistema de banderas
 */
import Layout from "@/layouts/Layout.astro";
import PageHeader from "@/components/ui/PageHeader.astro";
import InfoCard from "@/components/common/InfoCard.astro";
import FlagCard from "./_components/FlagCard.astro";
import flags from "@/utils/flags";

// Estadísticas
const totalFlags = flags.length;
const completedFlags = 0; // Se calculará en el cliente

interface Flag {
  id: string;
  title: string;
  description: string;
  category: string;
  difficulty: 'Básico' | 'Intermedio' | 'Avanzado';
  methodologies?: string[];
  correctFlag: string;
}

---

<Layout title="Banderas">
  <div class="container-lab py-8 flex flex-col gap-8">
    <PageHeader
      title="Captura la Bandera"
      subtitle="Hackea esta pagina, y registra aqui las banderas encontradas."
      gradient={true}
    />

    <!-- Estadísticas del CTF -->
    <div class="flex justify-center gap-4">
      <div id="stats-container" class="w-full max-w-md">
        <div class="card p-6 bg-gradient-to-br from-lab-primary-500/10 to-lab-accent-500/10 border border-lab-primary-500/20">
          <div class="text-4xl font-bold text-white mb-2 text-center">
            <span id="completed-count">0</span>/{totalFlags}
          </div>
          <div class="text-sm text-slate-400 text-center">Flags Completadas</div>
        </div>
      </div>
    </div>

    <script define:vars={{ flagsData: JSON.stringify(flags.map(f => ({ id: f.id, correctFlag: f.correctFlag }))), totalFlags: totalFlags }}>
      // Calcular flags completadas desde localStorage
      function updateCompletedCount() {
        const flags = JSON.parse(flagsData);
        let count = 0;
        flags.forEach((flag) => {
          const saved = localStorage.getItem(`flag-${flag.id}`);
          if (saved && saved === flag.correctFlag) {
            count++;
          }
        });
        const countElement = document.getElementById('completed-count');
        if (countElement) {
          countElement.textContent = count.toString();
        }
      }
      
      updateCompletedCount();
      // Actualizar cuando cambie localStorage (desde otra pestaña)
      window.addEventListener('storage', updateCompletedCount);
      // Actualizar cuando se complete una flag
      window.addEventListener('flag-completed', updateCompletedCount);
    </script>

    <!-- Lista de flags -->
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-white mb-4">Desafíos</h2>

      {
        flags.map((flag: Flag) => (
          <FlagCard
            id={flag.id}
            title={flag.title}
            description={flag.description}
            category={flag.category}
            difficulty={flag.difficulty}
            methodologies={flag.methodologies}
            correctFlag={flag.correctFlag}
          />
        ))
      }
    </div>

    <!-- Información sobre CTF -->
    <InfoCard title="¿Cómo funciona el CTF?">
      <div class="space-y-3 text-sm text-slate-400">
        <p>
          Cada desafío tiene una <strong class="text-white">flag</strong> que debes
          encontrar explotando una vulnerabilidad. Las flags tienen el formato: <code
            class="text-lab-primary-400 bg-slate-800 px-1.5 py-0.5 rounded"
            >{`FLAG{texto_aqui}`}</code
          >
        </p>
        <p>
          Todos los desafíos están disponibles desde el inicio. Pega la flag que encuentres
          en el campo de texto y verifica si es correcta.
        </p>
        <p>
          <strong class="text-white">Tip:</strong> Cada desafío muestra las metodologías
          que debes usar. Estudia cada vulnerabilidad antes de intentar explotarla.
        </p>
      </div>
    </InfoCard>
  </div>
</Layout>
